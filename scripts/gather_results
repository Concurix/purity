#!/bin/bash
# Extract test results from a list of files passed as command line arguments.
# Print the results to stdout.

scripts=$(dirname $0)
source $scripts/common

usage() {
    echo "usage: $(basename $0) file(s).erl"
    exit 1
}

extract() {
    file=$1
    # Assumes module name == file name.
    module=$(basename $(strip_suffix $file))
    sed -rn '
/%/ s/%+[ \t]*([a-z_][_a-zA-Z0-9]*\/[0-9])[ \t]+(true|\{false,.+\}|\[\{.+\}\])/'$module:'\1 \2./p
' $file | $scripts/esort
}

[[ -z "$@"  || '-h' == "$1" ]] && usage

for file in "$@"; do
    results=$(extract "$file")
    [[ -n "$results" ]]\
    && echo "$results" \
    || die "Could not extract results from $file"
done

